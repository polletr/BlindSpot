from pathlib import Path
import sys
path = Path(r"Assets\\Scripts\\SonarPing.cs")
text = path.read_text()
old = '    [Header("Ray fan quality")]\n    [Range(12, 180)] public int rayCount = 60;\n\n    [Header("Visual")]\n'
new = '    [Header("Ray fan quality")]\n    [Range(12, 180)] public int rayCount = 60;\n\n    [Header("Aim Input")]\n    public Camera aimCamera;\n    public InputActionReference lookAction;\n    [Tooltip("Pixels per second the virtual cursor moves when using the stick.")]\n    public float stickCursorSpeed = 1200f;\n    [Tooltip("Seconds before the aim cursor auto-hides after no input.")]\n    public float cursorHideDelay = 2f;\n    public Canvas cursorCanvas;\n    public RectTransform cursorVisual;\n    public bool hideCursorWhileUsingPointer = true;\n\n    [Header("Visual")]\n'
if old not in text:
    sys.exit('header block not found')
text = text.replace(old, new, 1)
old = '    float _nextReadyTime;\n    Coroutine _scanRoutine;\n'
new = '    float _nextReadyTime;\n    Coroutine _scanRoutine;\n\n    Vector2 _screenAimPosition;\n    Vector2 _stickLookValue;\n    bool _hasAimPosition;\n    bool _usingPointerDevice;\n    float _lastAimInputTime;\n\n    InputAction LookAction => lookAction != null ? lookAction.action : null;\n'
if old not in text:
    sys.exit('private field block not found')
text = text.replace(old, new, 1)
old = '    void Update()\n    {\n        if (Time.time < _nextReadyTime) return;\n    }\n'
new = '    void OnEnable()\n    {\n        var action = LookAction;\n        if (action != null)\n        {\n            action.performed += HandleLookInput;\n            action.canceled += HandleLookCanceled;\n            action.Enable();\n        }\n\n        EnsureAimPositionInitialized();\n    }\n\n    void OnDisable()\n    {\n        var action = LookAction;\n        if (action != null)\n        {\n            action.performed -= HandleLookInput;\n            action.canceled -= HandleLookCanceled;\n            action.Disable();\n        }\n\n        _stickLookValue = Vector2.zero;\n    }\n\n    void Update()\n    {\n        UpdateAimState();\n\n        if (Time.time < _nextReadyTime) return;\n    }\n'
if old not in text:
    sys.exit('update block not found')
text = text.replace(old, new, 1)
text = text.replace('GetMouseAim', 'GetAimDirection')
old_method = '    Vector2 GetAimDirection(Vector2 origin)\n    {\n        if (Camera.main == null || Mouse.current == null) return Vector2.right;\n\n        Vector2 mouseWorld = Camera.main.ScreenToWorldPoint(Mouse.current.position.ReadValue());\n        Vector2 aim = mouseWorld - origin;\n\n        if (aim.sqrMagnitude < 0.0001f) return Vector2.right;\n        return aim.normalized;\n    }\n'
new_method = '    Vector2 GetAimDirection(Vector2 origin)\n    {\n        Camera cam = GetAimCamera();\n        if (cam == null) return Vector2.right;\n\n        if (!_hasAimPosition)\n        {\n            _screenAimPosition = cam.WorldToScreenPoint(origin + Vector2.right);\n            _hasAimPosition = true;\n        }\n\n        Vector2 aimPoint = cam.ScreenToWorldPoint(_screenAimPosition);\n        Vector2 aim = aimPoint - origin;\n\n        if (aim.sqrMagnitude < 0.0001f) return Vector2.right;\n        return aim.normalized;\n    }\n'
if old_method not in text:
    sys.exit('aim method not found')
text = text.replace(old_method, new_method, 1)
marker = '    void RevealInCone('
if marker not in text:
    sys.exit('helper marker not found')
helpers = '    void UpdateAimState()\n    {\n        EnsureAimPositionInitialized();\n\n        if (!_usingPointerDevice && _stickLookValue.sqrMagnitude > 0.0001f && stickCursorSpeed > 0f)\n        {\n            float dt = Time.unscaledDeltaTime;\n            _screenAimPosition += _stickLookValue * (stickCursorSpeed * dt);\n            ClampScreenPosition(ref _screenAimPosition);\n            _hasAimPosition = true;\n            _lastAimInputTime = Time.unscaledTime;\n        }\n\n        UpdateCursorVisual();\n    }\n\n    void HandleLookInput(InputAction.CallbackContext ctx)\n    {\n        Vector2 value = ctx.ReadValue<Vector2>();\n        var device = ctx.control?.device;\n\n        if (device is Pointer)\n        {\n            _usingPointerDevice = true;\n            _screenAimPosition = value;\n            ClampScreenPosition(ref _screenAimPosition);\n            _hasAimPosition = true;\n        }\n        else\n        {\n            _usingPointerDevice = false;\n            _stickLookValue = value;\n        }\n\n        if (value.sqrMagnitude > 0.0001f)\n        {\n            _lastAimInputTime = Time.unscaledTime;\n        }\n    }\n\n    void HandleLookCanceled(InputAction.CallbackContext ctx)\n    {\n        if (ctx.control?.device is Pointer) return;\n        _stickLookValue = Vector2.zero;\n    }\n\n    void UpdateCursorVisual()\n    {\n        if (cursorVisual == null) return;\n\n        bool recentInput = cursorHideDelay <= 0f || (Time.unscaledTime - _lastAimInputTime) <= cursorHideDelay;\n        bool shouldShow = _hasAimPosition && recentInput;\n\n        if (hideCursorWhileUsingPointer && _usingPointerDevice)\n            shouldShow = false;\n\n        if (cursorVisual.gameObject.activeSelf != shouldShow)\n            cursorVisual.gameObject.SetActive(shouldShow);\n\n        if (!shouldShow) return;\n\n        Canvas canvas = cursorCanvas != null ? cursorCanvas : cursorVisual.GetComponentInParent<Canvas>();\n        if (canvas == null) return;\n\n        RectTransform targetRect = cursorVisual.parent as RectTransform;\n        if (targetRect == null)\n            targetRect = canvas.transform as RectTransform;\n        if (targetRect == null) return;\n\n        Camera canvasCamera = canvas.renderMode == RenderMode.ScreenSpaceOverlay ? null : canvas.worldCamera ?? GetAimCamera();\n\n        if (RectTransformUtility.ScreenPointToLocalPointInRectangle(targetRect, _screenAimPosition, canvasCamera, out Vector2 localPoint))\n        {\n            cursorVisual.anchoredPosition = localPoint;\n        }\n    }\n\n    void EnsureAimPositionInitialized()\n    {\n        if (_hasAimPosition) return;\n\n        if (Screen.width <= 0 || Screen.height <= 0)\n            return;\n\n        _screenAimPosition = new Vector2(Screen.width * 0.5f, Screen.height * 0.5f);\n        _hasAimPosition = true;\n    }\n\n    static void ClampScreenPosition(ref Vector2 position)\n    {\n        float width = Mathf.Max(1f, Screen.width);\n        float height = Mathf.Max(1f, Screen.height);\n        position.x = Mathf.Clamp(position.x, 0f, width);\n        position.y = Mathf.Clamp(position.y, 0f, height);\n    }\n\n    Camera GetAimCamera()\n    {\n        return aimCamera != null ? aimCamera : Camera.main;\n    }\n\n'
text = text.replace(marker, helpers + marker, 1)
path.write_text(text)
